# 实验报告

191098328 计算机科学与技术系 张世茂

### 1.实验完成度

本次实验我实现了一个可以解释固定格式的图灵机文件并接受输入然后在该图灵机上进行运行最终输出结果的C++程序。该程序能够通过g++编译生成一个可执行程序，可以通过固定格式的指令针对已经以规定格式给出的图灵机文件进行解释，然后将得到的图灵机存入数据结构中，并将指令中给出的外部输入在图灵机上运行和返回结果。同时，该程序还具有识别常见的不合法指令输入、参数输入以及图灵机并输出对应错误信息的功能。本次实验中我完成了该程序的两种运行模式的实现，分别是普通模式和verbose模式。最后，针对求解两个数的最大公约数，我实现了一个利用辗转相除法求解的有两条纸袋的图灵机，保存在对应的图灵机文件中。

### 2.分析与设计思路

#### 2.1 实现图灵机解释器

该实验的首要任务是实现一个图灵机文件的解释器，这是接下来一切动作的基础。由于合法的图灵机文件的内容是以固定格式给出的，因此我们就可以有一个明确的方式来获取图灵机中的各种信息并同时判断哪些信息是无效或者不合规的。在代码中我创建了`get_tm`函数用于获取图灵机文件中的信息到相应的数据结构中，因为需要住行对文件进行读取，为了简化实现，函数的输入为字符串类型的变量，其值为当前行的全部内容组成的字符串。

观察已给出的样例图灵机文件可以发现，文件中每行的信息主要由几部分构成：以分号‘；’为标志的注释，以‘#’为标志的图灵机信息行，无任何前缀字符串的转移函数行，空行，我们可以根据这些特征对每行的信息进行辨识和处理。在行中遇到分号时，就应该知道本行中其之后的字符串都是注释；在遇到井号时，就应当去判断后面是否跟着的是图灵机定义的组成部分；在遇到空行时，就应当不加处理地跳过；而在遇到直接开始的不符合上面这些符号特征的行时，就应当试图去判断其是否是一个转移函数。由于虽然理论上对图灵机限定了格式化的输入，但实际的测试场景下难免会出现不符合规范的输入的情况，应当对其中可接受的情况进行处理后接受，不可接受的情况打印相应的错误信息后退出执行。可接受的情况包括行首有空格，行末有不可见不可打印的ASCII字符等情况，这些因素不影响图灵机本身的语法构成，因此应当在对行字符串进行处理后正常执行；而不可接受的情况包括给出的图灵机定义中包括不可接受的非法字符、接受状态不在总的状态集合里、转移函数对应位置给出的值不符合定义要求等情况，这些情况都应当在相应的分支内进行处理，输出错误提示信息，返回错误码并退出。

本次实验中为了方便实现和调试，针对图灵机定义中不同的部分分别定义了不同的函数来对行内容进行处理。

经过上面的一系列处理我们就可以得到一组图灵机定义相关的数据结构，他们共同构成了一个图灵机。本次实验中我为图灵机定义的主要相关数据结构如下图所示：

<img src="/Users/zhangshimao/Library/Application Support/typora-user-images/image-20211227180146849.png" alt="image-20211227180146849" style="zoom: 33%;" />

另外的图灵机运行所需要的状态变量和表示全部纸带的数组在随后的图灵机运行函数中定义给出。同时可以注意到，虽然有些数据结构中存储的是单个字符，但为了统一接口和简化实现，将部分数据结构中存储的数据类型统一转化为了字符串类型。

#### 2.2 实现双模式图灵机运行模拟器

在得到了图灵机之后没接下来就是实现一个多带图灵机的模拟器，模拟一个特定输入在已有的图灵机上的运行。本实验中的运行模拟器需要分两个模式来实现，即普通模式和verbose模式，他们的运行原理是基本相同的，主要的区别在于verbose模式在运行的同时需要输出当前图灵机的具体状态信息，因此需要额外添加一些信息的获取和格式化输出的操作。将这两个运行模式分别通过函数`run_on_tm`和函数`run_on_tm_v`来实现。

在普通模式中，函数传入的参数为图灵机的输入。首先应当对输入进行检查，若输入存在非法字符则输出对应的错误信息并返回错误码后退出。若输入合法则定义纸带总体变量`tape* all_tape=new tape[N];`，并将所有纸带上的值先全部初始化为空白符B。之后在第一条纸带上合适的位置写入输入值。然后创建扫描头的数组`int *head=new int[N];`并将其初始化为对应的合适的值。以及必要地，为新旧状态、新旧符号串、带头移动方向等必要的信息分别都创建数组进行存储。在相应的工作都准备完成之后接下来就可以在一个while循环中运行图灵机，若当前的状态不在接受状态集中则继续进行循环，反之则结束循环并按照要求格式化输出第一条纸带上的内容。在每一步运行时根据当前的状态和符号组在转移函数里寻找对应的转移方案，找到之后则按照规则将对应的变量赋值，然后继续运行，若没有找到则说明停机，按照要求格式化输出第一条纸带上的信息并结束运行。

在verbose模式中，基础的运行操作与上面基本一致，而在遇到非法输入时，需要给出详细的报错信息以及第一个发生错误的位置，由于输出信息的格式是固定的，因此指示错误的箭头的位置可以通过位置索引的一次函数关系得到。每一轮打印图灵机运行状态的功能封装为一个函数`print_id`，通过将当前的状态信息作为参数传入可以进行格式化输出。其余的部分除增加了一些运行指示信息外基本与普通模式下的实现一致。

#### 2.3 实现计算最大公约数的多带图灵机程序

实现计算两个数最大公约数的多带图灵机程序，其本质上也就是实现运行辗转相除法的多带图灵机程序，因为辗转相除法就是计算两个数最大公约数的最简单也是最直接的算法。由于本次实验要求使用多带图灵机进行实现，且辗转相处法需要反复进行两个数之间的相减操作（由于图灵机的限制很难直接地计算除法，只能用多次减法来模拟除法得到余数的过程），因此可以很自然地想到使用包含2根纸带的图灵机进行实现。

想象一根纸带上作为被除数，一根纸带上作为除数，那么整体的实现思路就自然地浮现出来了：初始的输入是在第一根纸带上用0隔开的两个1的串表示的数，首先是要将一根纸带上的数转移到第二根纸带上，并将两个带头最终分别来到各自带上数串的两端，然后发生状态转移，接着两个带头分别向另一端移动，此时需要判断两根带上数串的长度关系，若同时到达B则说明一样长，即两数一样大，此时可以直接到接受状态，若长度有区别则将其分别转移到两个不同的状态，而在每个状态中执行带头的回复操作，即恢复到之前刚刚移动完数时的两端的位置，当检测到B时回退一格，并分别转移到另一个状态，准备开始计算。计算过程中，两个带头分别向另一端移动，不同的是，代表被除数的带上的1不断被修改为B，而代表除数的带上则不变。当除数到达B但被除数还未减完时，需要进入另一个状态，除数带上的带头转向继续对被除数带进行与刚才一样的减操作；当除数还未到头而被除数带已经到达B时，说明减多了，余数此时也被减掉了，因此要执行修正，进入另一个代表修正的状态后进行回退，并不断的将被除数带上被抹去的1补回，直至除数带带头到达B，再回退一步，就得到了一个除数和一个余数，因为此时虽然两条带上的带头都在两端，但其左右端的位置与q1状态（即最开始刚刚将一个数转移到第二条带上时进入的状态）时不一定一致，根据前面进入的不同状态情况，对相应的带头执行移动操作，直至移到另一端，此时回到q1状态继续执行；而当除数和被除数带带头同时到达B时，说明恰好减完，即余数为0，则此时的除数即是最终所要求的最大公约数，根据前面情况的不同，该数此时可能在第一根带上也可能在第二根带上，若在第一根带上则对应的转移函数直接转入接受状态，若在第二根带上则还需进入一个新状态，将此数从第二根带上转移到第一根带上后可进入接受状态。

### 3.实验中遇到的问题及解决方案

在将图灵机的解释器实现完成后利用自己编写的图灵机样例试运行时，发现会报错“synax error”，但肉眼观察图灵机文件的内容却发现不出来什么问题，由于有很多地方可能导致这种报错，我便尝试将这些报错根据情景加上不同的前缀然后再次尝试运行，定位处发生错误的具体位置，然后再将行的内容，行字符串内容的长度等相关内容进行输出比对，最终发现是文件中不可见字符导致的问题，对不可见字符进行特殊处理后该问题就解决了。

在实验过程中，由于图灵机的定义中有些量是字符串而有些量是单个字符，而使用C++对字符数组进行处理明显要比字符串麻烦的多，且由于数据类型不同则很难进行接口上的统一，需要进行很多额外的处理，因此后来对于这些变量采用统一化处理的方式，对于单个或多个字符全部采用string类型进行存储和处理，简化了实现。

实际上在本次实验过程中主要遇到的问题是各种字符串的处理以及对各种输入情况下程序所应做的应答的考虑是否全面，尤其是各种错误情况，为了尽力减少程序可能遇到的错误执行甚至崩溃，需要充分考虑各种可能的非法输入情况，将自己置于操作者的角度思考，这一工作是这次实验代码实现的最主要部分，将这些工作较好地实现后，运行模拟器以及求解最大公因数的多带图灵机的设计就是水到渠成了。

### 4.总结感想

这次实验是FLA课程最后也是唯一一次大实验，一通做下来，不仅可以较好地提升对于课程内容中图灵机功能和设计的理解，同时也是对字符串处理、鲁棒性考虑、文件处理相关能力的考验。实验进行到这里时已经接近尾声了，课程内容也早已在上周就结束了，感谢老师和助教们一学期的辛苦付出。期末考试已经迫在眉睫了，虽然近日都在忙于各种作业和大实验的ddl，尚未能正式地开始专注复习，感觉专业知识还有很多欠缺之处，但仍希望能够通过尽力的准备去的一个理想的成绩，为这学期的FLA课程画上圆满的句号。

### 5.对课程和实验的建议

本次课程实验虽然可以在实现的过程中使综合代码能力和对专业知识的掌握程度都获得提升，但在进行实验的过程中可以感觉到基本上大多数的时间都用于进行各种字符串处理、输入输出格式处理、错误处理，图灵机作为本次实验的精神内核反而色彩较弱，只花费了整个实验过程中的较少时间，总的来说有点像之前上过的卜磊老师的程设实验课。如果能在当前实验设计的基础上适当地增加FLA相关内容所占的比重而适当淡化其余的部分的实现，大概可以和本课程结合的更好。